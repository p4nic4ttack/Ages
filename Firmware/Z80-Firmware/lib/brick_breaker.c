#include <brick_breaker.h>
const uint8_t bb_image[] = {0x00, 0x57, 0x56, 0x56, 0x46, 0x14, 0x10, 0x52, 0x46, 0x56, 0x56, 0x56, 0x56, 0x46, 0x16, 0x50, 0x56, 0x46, 0x56, 0x56, 0x56, 0x44, 0x56, 0x11, 0x51, 0x56, 0x56, 0x56, 0x56, 0x56, 0x46, 0x16, 0x50, 0x54, 0x46, 0x56, 0x16, 0xd7, 0xd6, 0x56, 0x57, 0x50, 0x16, 0x46, 0x56, 0x56, 0x57, 0x46, 0x56, 0x57, 0x50, 0x06, 0x56, 0x56, 0xd6, 0x56, 0x46, 0x56, 0x50, 0x16, 0x46, 0x56, 0x56, 0x56, 0x46, 0x56, 0x56, 0x50, 0x16, 0x46, 0x56, 0x57, 0x57, 0x46, 0x56, 0x56, 0x16, 0x46, 0x56, 0x56, 0x56, 0x46, 0x47, 0x00, 0x00, 0xaa, 0xab, 0xa8, 0x88, 0xab, 0x2a, 0xaa, 0x83, 0xab, 0xab, 0xab, 0xa8, 0x8b, 0x2b, 0x2a, 0x2b, 0x23, 0x2a, 0xab, 0xab, 0x08, 0x2b, 0x2a, 0x2b, 0x23, 0x2a, 0x28, 0x2b, 0x28, 0x08, 0x0b, 0x0b, 0x0b, 0x03, 0x03, 0x03, 0x03, 0x00, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x03, 0x02, 0x00, 0x03, 0x01, 0x09, 0x0b, 0x89, 0x89, 0xab, 0xa8, 0xab, 0xab, 0xa3, 0x2b, 0xab, 0x8b, 0x88, 0xab, 0xaf, 0xab, 0x23, 0x22, 0x2b, 0x2b, 0x08, 0xa9, 0xab, 0xab, 0xab, 0xa3, 0x2b, 0xab, 0xab, 0x88, 0xab, 0xab, 0xab, 0x00, 0x00, 0x57, 0x57, 0x15, 0x11, 0x57, 0x44, 0x55, 0x51, 0x55, 0x57, 0x57, 0x11, 0x11, 0x46, 0x46, 0x55, 0x51, 0x57, 0x56, 0x57, 0x11, 0x15, 0x04, 0x14, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x00, 0x07, 0x47, 0x47, 0x40, 0x46, 0x46, 0x56, 0x50, 0x56, 0x1e, 0x56, 0x50, 0x58, 0x46, 0x46, 0x56, 0x50, 0x16, 0x16, 0x56, 0x50, 0x56, 0x46, 0x56, 0x10, 0x56, 0x56, 0x56, 0x00, 0x00, 0x2b, 0x2a, 0x2a, 0x22, 0xaa, 0x8b, 0xaa, 0xa8, 0xaa, 0xab, 0xab, 0x2a, 0x03, 0xab, 0x8b, 0xa8, 0x28, 0x2b, 0xab, 0xab, 0x23, 0xab, 0xab, 0x8b, 0x08, 0x88, 0x88, 0x88, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x88, 0x88, 0x28, 0x28, 0xad, 0xaf, 0xaf, 0x23, 0xab, 0x8b, 0xad, 0x0c, 0xaf, 0x8d, 0xaf, 0xab, 0xa1, 0xad, 0x2c, 0xad, 0x8d, 0xad, 0x21, 0x2d, 0xad, 0xad, 0x00, 0x00, 0xd7, 0xd5, 0xd4, 0xc4, 0x15, 0x91, 0xd5, 0xd5, 0xd5, 0xd5, 0xd5, 0xc4, 0xc5, 0x15, 0x11, 0x95, 0x94, 0xd5, 0xd5, 0xd5, 0xc4, 0x54, 0x11, 0xd1, 0xd0, 0xd1, 0xc1, 0xc1, 0xc0, 0xc0, 0xc0, 0x00, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x40, 0x40, 0x40, 0x50, 0x50, 0x50, 0x50, 0x11, 0x56, 0x56, 0x56, 0x46, 0x56, 0x56, 0x56, 0x10, 0x56, 0x56, 0x16, 0x46, 0x56, 0x50, 0x56, 0x56, 0x16, 0x50, 0x56, 0x56, 0x46, 0x46, 0x46, 0x56, 0x00, 0x00, 0xea, 0x6a, 0x68, 0xe8, 0x68, 0x2a, 0x6a, 0x0a, 0x68, 0x6a, 0x6a, 0x0a, 0x28, 0x62, 0x6b, 0x6b, 0x0a, 0x62, 0x63, 0x6a, 0x08, 0x68, 0x6b, 0x62, 0x03, 0x63, 0x6a, 0x6b, 0x2a, 0x08, 0x6a, 0x6b, 0x63, 0x0b, 0x6b, 0x6b, 0x6a, 0x0b, 0x68, 0x6b, 0x6b, 0x63, 0x0a, 0x6b, 0x6b, 0x6a, 0x8b, 0x68, 0x6b, 0x63, 0x0b, 0x2b, 0xeb, 0x6b, 0x6b, 0x08, 0x68, 0x6b, 0x63, 0x03, 0x6b, 0xeb, 0xeb, 0x8b, 0xe8, 0xeb, 0x2b, 0xa3, 0x8b, 0xeb, 0xeb, 0xeb, 0x0b, 0x68, 0x6b, 0x63, 0x0b, 0x2b, 0x68, 0x29, 0x23, 0xab, 0x00};
void init_brickbreaker(Brick bricks[], Ball *ball, Paddle *paddle) {
    bricks[0].x = 2;
    bricks[0].y = 0;
    bricks[1].x = 6;
    bricks[1].y = 0;
    bricks[2].x = 10;
    bricks[2].y = 0;
    bricks[3].x = 14;
    bricks[3].y = 0;
    bricks[4].x = 0;
    bricks[4].y = 1;
    bricks[5].x = 4;
    bricks[5].y = 1;
    bricks[6].x = 8;
    bricks[6].y = 1;
    bricks[7].x = 12;
    bricks[7].y = 1;
    bricks[8].x = 0;
    bricks[8].y = 2;
    bricks[9].x = 1;
    bricks[9].y = 2;
    bricks[10].x = 3;
    bricks[10].y = 2;
    bricks[11].x = 4;
    bricks[11].y = 2;
    bricks[12].x = 5;
    bricks[12].y = 2;
    bricks[13].x = 7;
    bricks[13].y = 2;
    bricks[14].x = 8;
    bricks[14].y = 2;
    bricks[15].x = 9;
    bricks[15].y = 2;
    bricks[16].x = 11;
    bricks[16].y = 2;
    bricks[17].x = 12;
    bricks[17].y = 2;
    bricks[18].x = 13;
    bricks[18].y = 2;
    bricks[19].x = 15;
    bricks[19].y = 2;
    bricks[20].x = 2;
    bricks[20].y = 4;
    bricks[21].x = 6;
    bricks[21].y = 4;
    bricks[22].x = 10;
    bricks[22].y = 4;
    bricks[23].x = 14;
    bricks[23].y = 4;
    bricks[24].x = 1;
    bricks[24].y = 5;
    bricks[25].x = 2;
    bricks[25].y = 5;
    bricks[26].x = 3;
    bricks[26].y = 5;
    bricks[27].x = 5;
    bricks[27].y = 5;
    bricks[28].x = 6;
    bricks[28].y = 5;
    bricks[29].x = 7;
    bricks[29].y = 5;
    bricks[30].x = 9;
    bricks[30].y = 5;
    bricks[31].x = 10;
    bricks[31].y = 5;
    bricks[32].x = 11;
    bricks[32].y = 5;
    bricks[33].x = 13;
    bricks[33].y = 5;
    bricks[34].x = 14;
    bricks[34].y = 5;
    bricks[35].x = 15;
    bricks[35].y = 5;
    bricks[36].x = 1;
    bricks[36].y = 6;
    bricks[37].x = 2;
    bricks[37].y = 6;
    bricks[38].x = 3;
    bricks[38].y = 6;
    bricks[39].x = 5;
    bricks[39].y = 6;
    bricks[40].x = 6;
    bricks[40].y = 6;
    bricks[41].x = 7;
    bricks[41].y = 6;
    bricks[42].x = 9;
    bricks[42].y = 6;
    bricks[43].x = 10;
    bricks[43].y = 6;
    bricks[44].x = 11;
    bricks[44].y = 6;
    bricks[45].x = 13;
    bricks[45].y = 6;
    bricks[46].x = 14;
    bricks[46].y = 6;
    bricks[47].x = 15;
    bricks[47].y = 6;
    bricks[48].x = 0;
    bricks[48].y = 8;
    bricks[49].x = 1;
    bricks[49].y = 8;
    bricks[50].x = 2;
    bricks[50].y = 8;
    bricks[51].x = 3;
    bricks[51].y = 8;
    bricks[52].x = 4;
    bricks[52].y = 8;
    bricks[53].x = 5;
    bricks[53].y = 8;
    bricks[54].x = 6;
    bricks[54].y = 8;
    bricks[55].x = 7;
    bricks[55].y = 8;
    bricks[56].x = 8;
    bricks[56].y = 8;
    bricks[57].x = 9;
    bricks[57].y = 8;
    bricks[58].x = 10;
    bricks[58].y = 8;
    bricks[59].x = 11;
    bricks[59].y = 8;
    bricks[60].x = 12;
    bricks[60].y = 8;
    bricks[61].x = 13;
    bricks[61].y = 8;
    bricks[62].x = 14;
    bricks[62].y = 8;
    bricks[63].x = 15;
    bricks[63].y = 8;
    for(uint8_t i = 0; i < 64; i++)
      bricks[i].active = true;
    paddle->x = 7;
    ball->x = 7;
    ball->y = 14;
    ball->dx = ((rand() % 2)==0) ? 1 : -1;
    ball->dy = ((rand() % 2)==0) ? 1 : -1;
}

void shift_bricks_left(Brick bricks[]){
  for(uint8_t i = 0; i < 48; i++){
    if(bricks[i].active){
      uint8_t x = bricks[i].x;
      bricks[i].x = (x + 1);
    }
  }
}

void shift_bricks_right(Brick bricks[]){
  for(uint8_t i = 0; i < 48; i++){
    if(bricks[i].active){
      uint8_t x = bricks[i].x;
      bricks[i].x = (x - 1);
    }
  }
}

void main_brickbreaker_loop(){
  Brick bricks[64];
  Ball ball;
  Paddle paddle;
  bool left = false;
  bool shift = false;
  uint8_t shift_cnt = 0;
  uint16_t score = 0;
  uint16_t prev_score = 0;
  init_brickbreaker(bricks, &ball, &paddle);
  lcd_out_char(0xff);
  lcd_draw(bb_image, 0, 0, 504);
  while(1){
    clear_framebuffer();
    get_input_brickbreaker(&paddle);
    move_ball(&ball, &paddle);
    check_collision_brickbreaker(bricks, &ball, &score);
    char score_str[4];
    sprintf(score_str, "%d", score);
    if(score > prev_score){
      prev_score = score;
      lcd_out_str(score_str, 33, 3);
    }
    if(score >= 80){
      if(left && shift){
        shift_bricks_left(bricks);
        left = false;
        shift_cnt = 0;
        shift = false;
      }else if(!(left) && shift){
        shift_bricks_right(bricks);
        left = true;
        shift = false;
        shift_cnt = 0;
      }
      if(shift_cnt == 7){
        shift = true;
      }else{
        shift_cnt += 1;
      }
    }
    draw(bricks, &ball, &paddle);
    if(ball.y == 15){
      lcd_out_char(0xff);
      lcd_out_str("~~~~Score~~~~", 0, 0);
      lcd_out_str(score_str, 30, 2);
      lcd_out_str("~~~~~~~~~~~~~", 0, 4);
      break;
    }
    for(uint8_t i = 0; i < 100; i++)
      delay1ms();
    }
}

void draw(Brick bricks[], const Ball *ball, const Paddle *paddle){
  clear_framebuffer();
  for(uint8_t i = 0; i < 64; i++){
    if(bricks[i].active == true)
      set_pixel(bricks[i].x, bricks[i].y);
  }
  set_pixel(paddle->x, 15);
  set_pixel(paddle->x-1, 15);
  set_pixel(paddle->x+1, 15);
  set_pixel(ball->x, ball->y);
  update_framebuffer(framebuffer);
}


void get_input_brickbreaker(Paddle *paddle){
  if(lft_pressed() == BTN_PRESSED || lft_pressed() == BTN_HOLD)
    if(paddle->x < 14)
      paddle->x++;
  if(rgt_pressed() == BTN_PRESSED || rgt_pressed() == BTN_HOLD)
    if(paddle->x > 1)
      paddle->x--;
  for(uint8_t i = 0; i < 15; i++)
    delay1ms();
}

void move_ball(Ball *ball, const Paddle *paddle){
  ball->x += ball->dx;
  if(ball->x == 0 || ball->x == 15){
    ball->dx = -ball->dx;
    ball->x += ball->dx; 
  }
  ball->y += ball->dy;
  //Top border or paddle
  if(ball->y == 0 || (ball->y == 15 && ball->x == paddle->x) || (ball->y == 15 && ball->x == paddle->x-1) || (ball->y == 15 && ball->x == paddle->x+1) ){
    ball->dy = -ball->dy;
    ball->y += ball->dy;
  }
}

void check_collision_brickbreaker(Brick bricks[MATRIX_SIZE], Ball *ball, int *score){
  int nextX = ball->x + ball->dx;
  int nextY = ball->y + ball->dy;
  for(uint8_t i = 0; i < 64; i++){
    if(bricks[i].x == nextX && bricks[i].y == nextY){
      if(bricks[i].active == true){
        ball->dy = -ball->dy;
        bricks[i].active = false;
        *score += 10;
      }
    }
  }
}

/*bool check_win(Brick bricks[MATRIX_SIZE][MATRIX_SIZE]){
  for(uint8_t i = 0; i < MATRIX_SIZE; i++) {
    for (uint8_t j = 0; j < MATRIX_SIZE; j++) {
      if (bricks[i][j].active) {
        return false;
      }
    }
  }
  return true;
}*/